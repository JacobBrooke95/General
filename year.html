<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Year Clock</title>
<style>
  @import url('https://fonts.googleapis.com/css2?family=Inter:wght@200;300;400;500;600&family=Space+Mono:wght@400;700&family=Playfair+Display:wght@300;400;500&family=DM+Serif+Display&display=swap');

  * { margin: 0; padding: 0; box-sizing: border-box; }

  body {
    min-height: 100vh;
    display: flex;
    align-items: center;
    justify-content: center;
    background: var(--bg);
    color: var(--text);
    transition: background 0.6s ease, color 0.6s ease;
    -webkit-font-smoothing: antialiased;
    overflow: hidden;
  }

  :root {
    --bg: #110c06;
    --surface: #1a1208;
    --surface2: #231a0e;
    --border: rgba(255,180,80,0.06);
    --text: #f0dcc0;
    --text2: #aa8855;
    --text3: #665533;
    --accent: #e8942a;
    --accent-glow: rgba(232,148,42,0.3);
    --hand-h: #ccaa77;
    --hand-m: #e0c898;
    --hand-s: #e8942a;
    --tick-major: #8a7050;
    --tick-minor: #3a2e1e;
    --num-fill: #8a7050;
    --num-fill-bright: #bba070;
    --center-outer: #3a2e1e;
    --ambient-color: rgba(232,148,42,0.06);
    --font: 'Playfair Display', Georgia, serif;
    --font-time: 'Playfair Display', serif;
    --time-weight: 300;
  }

  .ambient {
    position: fixed;
    top: -200px;
    left: 50%;
    transform: translateX(-50%);
    width: 700px;
    height: 500px;
    background: radial-gradient(ellipse, var(--ambient-color) 0%, transparent 70%);
    pointer-events: none;
    z-index: 0;
    transition: background 0.8s ease;
  }

  .app {
    position: relative;
    z-index: 1;
    display: flex;
    flex-direction: column;
    align-items: center;
    gap: 0;
    font-family: var(--font);
    max-width: 560px;
    width: 100%;
    padding: 20px;
  }

  /* ===== NAV ===== */
  .nav-link {
    margin-bottom: 24px;
    display: flex; gap: 6px; align-items: center;
  }
  .nav-link a {
    font-family: var(--font);
    font-size: 11px;
    color: var(--text3);
    text-decoration: none;
    letter-spacing: 1.5px;
    text-transform: uppercase;
    transition: color 0.3s;
  }
  .nav-link a:hover { color: var(--text2); }
  .nav-link .sep { color: var(--text3); opacity: 0.4; font-size: 10px; }
  .nav-link .current {
    font-family: var(--font);
    font-size: 11px;
    color: var(--text);
    letter-spacing: 1.5px;
    text-transform: uppercase;
    font-weight: 500;
  }

  /* ===== CONTROLS ===== */
  .controls {
    display: flex;
    align-items: center;
    justify-content: center;
    gap: 12px;
    margin-bottom: 36px;
    flex-wrap: wrap;
  }

  .pill-group {
    display: flex;
    gap: 2px;
    padding: 3px;
    background: var(--surface);
    border-radius: 10px;
    border: 1px solid var(--border);
    transition: background 0.4s, border-color 0.4s;
  }

  .pill-btn {
    padding: 7px 14px;
    background: none;
    border: none;
    color: var(--text3);
    font-family: var(--font);
    font-size: 11px;
    font-weight: 500;
    letter-spacing: 0.8px;
    text-transform: uppercase;
    cursor: pointer;
    border-radius: 8px;
    transition: all 0.25s ease;
    white-space: nowrap;
  }

  .pill-btn:hover { color: var(--text2); }

  .pill-btn.active {
    background: var(--surface2);
    color: var(--text);
    box-shadow: 0 1px 6px rgba(0,0,0,0.25);
  }

  .mode-btn {
    width: 36px;
    height: 36px;
    border-radius: 10px;
    border: 1px solid var(--border);
    background: var(--surface);
    color: var(--text3);
    cursor: pointer;
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 16px;
    transition: all 0.3s ease;
    flex-shrink: 0;
  }

  .mode-btn:hover { color: var(--text2); border-color: rgba(255,255,255,0.08); }

  /* ===== ORBITAL RING ===== */
  .orbital-clock {
    width: 420px;
    height: 420px;
    margin-bottom: 36px;
    transition: filter 0.4s;
  }
  .orbital-clock svg { width: 100%; height: 100%; }

  /* Season arcs */
  .season-arc { fill: none; stroke-width: 18; opacity: 0.12; transition: stroke 0.4s, opacity 0.4s; }
  .season-spring { stroke: #44cc66; }
  .season-summer { stroke: #ffaa22; }
  .season-autumn { stroke: #dd5533; }
  .season-winter { stroke: #4488dd; }

  /* Ring background */
  .ring-bg { fill: none; stroke: var(--surface2); stroke-width: 22; transition: stroke 0.4s; }
  .ring-border-outer, .ring-border-inner { fill: none; stroke: var(--border); stroke-width: 0.8; transition: stroke 0.4s; }

  /* Month ticks */
  .month-tick { stroke: var(--tick-major); stroke-width: 2; stroke-linecap: round; transition: stroke 0.4s; }
  .week-tick { stroke: var(--tick-minor); stroke-width: 0.8; stroke-linecap: round; transition: stroke 0.4s; }

  /* Month labels */
  .month-label {
    fill: var(--num-fill);
    font-size: 11px;
    font-weight: 400;
    text-anchor: middle;
    dominant-baseline: central;
    font-family: var(--font);
    letter-spacing: 0.5px;
    transition: fill 0.4s;
  }
  .month-label.current-month { fill: var(--text); font-weight: 500; }

  /* Solstice / equinox markers */
  .marker-dot { fill: var(--text3); transition: fill 0.4s; }
  .marker-label {
    fill: var(--text3);
    font-size: 7px;
    text-anchor: middle;
    dominant-baseline: central;
    font-family: var(--font);
    letter-spacing: 0.6px;
    text-transform: uppercase;
    transition: fill 0.4s;
  }

  /* Hand / indicator */
  .year-hand { stroke: var(--accent); stroke-width: 2.5; stroke-linecap: round; filter: drop-shadow(0 0 6px var(--accent-glow)); transition: stroke 0.4s, filter 0.4s; }
  .year-dot { fill: var(--accent); filter: drop-shadow(0 0 8px var(--accent-glow)); transition: fill 0.4s, filter 0.4s; }
  .year-dot-halo { fill: var(--accent); opacity: 0.15; transition: fill 0.4s; }

  .center-outer { fill: var(--center-outer); transition: fill 0.4s; }
  .center-inner { fill: var(--accent); transition: fill 0.4s; }

  /* Daylight bars */
  .daylight-bar { stroke-linecap: butt; opacity: 0.55; transition: stroke 0.4s, opacity 0.4s; }
  .daylight-bar.past { opacity: 0.25; }

  /* Trail arc showing elapsed year */
  .trail-arc { fill: none; stroke: var(--accent); stroke-width: 4; opacity: 0.25; stroke-linecap: round; transition: stroke 0.4s; }

  /* ===== STATS ===== */
  .stats {
    display: flex;
    gap: 40px;
    margin-bottom: 10px;
    flex-wrap: wrap;
    justify-content: center;
  }

  .stat {
    display: flex;
    flex-direction: column;
    align-items: center;
    gap: 4px;
  }

  .stat-value {
    font-family: var(--font-time);
    font-size: 36px;
    font-weight: var(--time-weight);
    color: var(--text);
    line-height: 1;
    font-variant-numeric: tabular-nums;
    transition: color 0.4s, font-family 0.3s;
  }

  .stat-value .unit {
    font-size: 16px;
    color: var(--accent);
    font-weight: 400;
    margin-left: 2px;
    transition: color 0.4s;
  }

  .stat-label {
    font-size: 10px;
    color: var(--text3);
    letter-spacing: 2px;
    text-transform: uppercase;
    transition: color 0.4s;
  }

  .date-line {
    font-family: var(--font);
    font-size: 15px;
    color: var(--text3);
    letter-spacing: 2.5px;
    text-transform: uppercase;
    font-weight: 400;
    margin-bottom: 4px;
    transition: color 0.4s;
  }

  .sub-line {
    font-size: 11px;
    color: var(--text3);
    letter-spacing: 1.5px;
    opacity: 0.5;
    transition: color 0.4s;
  }
</style>
</head>
<body>

<div class="ambient" id="ambient"></div>

<div class="app">
  <!-- Navigation -->
  <div class="nav-link">
    <a href="clock.html">Clock</a>
    <span class="sep">/</span>
    <span class="current">Year</span>
  </div>

  <!-- Controls -->
  <div class="controls">
    <div class="pill-group" id="style-group">
      <button class="pill-btn" data-style="main">Main</button>
      <button class="pill-btn" data-style="retro">Retro</button>
      <button class="pill-btn active" data-style="warm">Warm</button>
      <button class="pill-btn" data-style="classic">Classic</button>
    </div>
    <button class="mode-btn" id="mode-toggle" title="Toggle light/dark">&#9790;</button>
  </div>

  <!-- Orbital Ring -->
  <div class="orbital-clock">
    <svg viewBox="-10 -10 420 420" id="orbit-svg">
      <defs>
        <filter id="glow">
          <feGaussianBlur stdDeviation="3" result="blur"/>
          <feMerge><feMergeNode in="blur"/><feMergeNode in="SourceGraphic"/></feMerge>
        </filter>
      </defs>

      <!-- Season arcs (drawn by JS) -->
      <g id="seasons"></g>

      <!-- Ring background -->
      <circle cx="200" cy="200" r="155" class="ring-bg"/>
      <circle cx="200" cy="200" r="166" class="ring-border-outer"/>
      <circle cx="200" cy="200" r="144" class="ring-border-inner"/>

      <!-- Daylight radial bars -->
      <g id="daylight-bars"></g>

      <!-- Month ticks and week ticks -->
      <g id="ticks"></g>

      <!-- Month labels -->
      <g id="labels"></g>

      <!-- Solstice/equinox markers -->
      <g id="markers"></g>

      <!-- Trail arc -->
      <path id="trail-arc" class="trail-arc" d=""/>

      <!-- Year hand -->
      <line id="year-hand" class="year-hand" x1="200" y1="200" x2="200" y2="200"/>

      <!-- Indicator dot -->
      <circle id="dot-halo" class="year-dot-halo" cx="200" cy="40" r="10"/>
      <circle id="dot-main" class="year-dot" cx="200" cy="40" r="5"/>

      <!-- Center -->
      <circle cx="200" cy="200" r="30" class="center-outer"/>
      <circle cx="200" cy="200" r="26" class="center-inner" style="fill: var(--surface); transition: fill 0.4s;"/>

      <!-- Center text (year) -->
      <text id="center-year" x="200" y="200" text-anchor="middle" dominant-baseline="central"
            style="fill: var(--text); font-size: 14px; font-weight: 500; font-family: var(--font); letter-spacing: 1px; transition: fill 0.4s;"></text>
    </svg>
  </div>

  <!-- Stats readout -->
  <div class="stats">
    <div class="stat">
      <div class="stat-value" id="stat-pct">0<span class="unit">%</span></div>
      <div class="stat-label">Year Complete</div>
    </div>
    <div class="stat">
      <div class="stat-value" id="stat-day">0</div>
      <div class="stat-label">Day of Year</div>
    </div>
    <div class="stat">
      <div class="stat-value" id="stat-remain">0</div>
      <div class="stat-label">Days Remaining</div>
    </div>
    <div class="stat">
      <div class="stat-value" id="stat-light">0<span class="unit">h</span></div>
      <div class="stat-label">Daylight Today</div>
    </div>
  </div>

  <div class="date-line" id="date-line"></div>
  <div class="sub-line" id="season-line"></div>
</div>

<script>
const CX = 200, CY = 200, R = 155;
const $ = s => document.querySelector(s);
const $$ = s => document.querySelectorAll(s);

let currentStyle = 'warm';
let isDark = true;

// ===== THEMES (shared with clock.html) =====
const themes = {
  main: {
    dark: {
      bg:'#0a0a0f', surface:'#12121a', surface2:'#1a1a25', border:'rgba(255,255,255,0.03)',
      text:'#eeeef2', text2:'#8888a0', text3:'#55556a',
      accent:'#ff4f4f', accentGlow:'rgba(255,79,79,0.3)',
      handH:'#c0c0cc', handM:'#dddde8', handS:'#ff4f4f',
      tickMajor:'#666680', tickMinor:'#2a2a38',
      numFill:'#77778a', numBright:'#9999aa', centerOuter:'#2a2a38',
      ambient:'rgba(255,79,79,0.06)',
      font:"'Inter', -apple-system, system-ui, sans-serif",
      fontTime:"'Inter', sans-serif", timeWeight:'200',
    },
    light: {
      bg:'#f4f4f8', surface:'#ffffff', surface2:'#eeeef3', border:'rgba(0,0,0,0.06)',
      text:'#1a1a2e', text2:'#666688', text3:'#999aaf',
      accent:'#e03030', accentGlow:'rgba(224,48,48,0.2)',
      handH:'#333348', handM:'#222238', handS:'#e03030',
      tickMajor:'#888898', tickMinor:'#ccccda',
      numFill:'#777790', numBright:'#555568', centerOuter:'#ccccda',
      ambient:'rgba(224,48,48,0.05)',
      font:"'Inter', -apple-system, system-ui, sans-serif",
      fontTime:"'Inter', sans-serif", timeWeight:'200',
    }
  },
  retro: {
    dark: {
      bg:'#080c08', surface:'#0e140e', surface2:'#141e14', border:'rgba(50,255,50,0.06)',
      text:'#33ff66', text2:'#22aa44', text3:'#116622',
      accent:'#33ff66', accentGlow:'rgba(50,255,100,0.3)',
      handH:'#22cc44', handM:'#28ee55', handS:'#33ff66',
      tickMajor:'#22aa44', tickMinor:'#0e4418',
      numFill:'#22aa44', numBright:'#33ff66', centerOuter:'#0e4418',
      ambient:'rgba(50,255,100,0.05)',
      font:"'Space Mono', monospace",
      fontTime:"'Space Mono', monospace", timeWeight:'400',
    },
    light: {
      bg:'#eaf5ea', surface:'#f8fdf8', surface2:'#e0efe0', border:'rgba(0,80,0,0.08)',
      text:'#0a3a0a', text2:'#336633', text3:'#88aa88',
      accent:'#007722', accentGlow:'rgba(0,120,34,0.15)',
      handH:'#225522', handM:'#1a441a', handS:'#007722',
      tickMajor:'#558855', tickMinor:'#bbddbb',
      numFill:'#447744', numBright:'#225522', centerOuter:'#bbddbb',
      ambient:'rgba(0,120,34,0.04)',
      font:"'Space Mono', monospace",
      fontTime:"'Space Mono', monospace", timeWeight:'400',
    }
  },
  warm: {
    dark: {
      bg:'#110c06', surface:'#1a1208', surface2:'#231a0e', border:'rgba(255,180,80,0.06)',
      text:'#f0dcc0', text2:'#aa8855', text3:'#665533',
      accent:'#e8942a', accentGlow:'rgba(232,148,42,0.3)',
      handH:'#ccaa77', handM:'#e0c898', handS:'#e8942a',
      tickMajor:'#8a7050', tickMinor:'#3a2e1e',
      numFill:'#8a7050', numBright:'#bba070', centerOuter:'#3a2e1e',
      ambient:'rgba(232,148,42,0.06)',
      font:"'Playfair Display', Georgia, serif",
      fontTime:"'Playfair Display', serif", timeWeight:'300',
    },
    light: {
      bg:'#faf5ec', surface:'#fff9f0', surface2:'#f0e8d8', border:'rgba(120,80,20,0.08)',
      text:'#3a2810', text2:'#886640', text3:'#bbaa88',
      accent:'#c07020', accentGlow:'rgba(192,112,32,0.18)',
      handH:'#6a5030', handM:'#4a3820', handS:'#c07020',
      tickMajor:'#9a8868', tickMinor:'#ddd0bb',
      numFill:'#7a6848', numBright:'#5a4828', centerOuter:'#ddd0bb',
      ambient:'rgba(192,112,32,0.04)',
      font:"'Playfair Display', Georgia, serif",
      fontTime:"'Playfair Display', serif", timeWeight:'300',
    }
  },
  classic: {
    dark: {
      bg:'#080a14', surface:'#101420', surface2:'#181e2e', border:'rgba(200,180,100,0.06)',
      text:'#d8d0c0', text2:'#8888a0', text3:'#555570',
      accent:'#c8a050', accentGlow:'rgba(200,160,80,0.25)',
      handH:'#9898b0', handM:'#b0b0c8', handS:'#c8a050',
      tickMajor:'#6a6a88', tickMinor:'#2a2a40',
      numFill:'#707088', numBright:'#9898b0', centerOuter:'#2a2a40',
      ambient:'rgba(200,160,80,0.05)',
      font:"'DM Serif Display', Georgia, serif",
      fontTime:"'DM Serif Display', serif", timeWeight:'400',
    },
    light: {
      bg:'#f0f0f8', surface:'#fafafe', surface2:'#e8e8f2', border:'rgba(40,40,80,0.07)',
      text:'#1a1a30', text2:'#6a6a88', text3:'#9898b0',
      accent:'#8a6820', accentGlow:'rgba(138,104,32,0.15)',
      handH:'#3a3a58', handM:'#282840', handS:'#8a6820',
      tickMajor:'#787899', tickMinor:'#ccccdd',
      numFill:'#606078', numBright:'#3a3a58', centerOuter:'#ccccdd',
      ambient:'rgba(138,104,32,0.04)',
      font:"'DM Serif Display', Georgia, serif",
      fontTime:"'DM Serif Display', serif", timeWeight:'400',
    }
  }
};

function applyTheme() {
  const t = themes[currentStyle][isDark ? 'dark' : 'light'];
  const r = document.documentElement.style;
  r.setProperty('--bg', t.bg);
  r.setProperty('--surface', t.surface);
  r.setProperty('--surface2', t.surface2);
  r.setProperty('--border', t.border);
  r.setProperty('--text', t.text);
  r.setProperty('--text2', t.text2);
  r.setProperty('--text3', t.text3);
  r.setProperty('--accent', t.accent);
  r.setProperty('--accent-glow', t.accentGlow);
  r.setProperty('--hand-h', t.handH);
  r.setProperty('--hand-m', t.handM);
  r.setProperty('--hand-s', t.handS);
  r.setProperty('--tick-major', t.tickMajor);
  r.setProperty('--tick-minor', t.tickMinor);
  r.setProperty('--num-fill', t.numFill);
  r.setProperty('--num-fill-bright', t.numBright);
  r.setProperty('--center-outer', t.centerOuter);
  r.setProperty('--ambient-color', t.ambient);
  r.setProperty('--font', t.font);
  r.setProperty('--font-time', t.fontTime);
  r.setProperty('--time-weight', t.timeWeight);
  $('#mode-toggle').innerHTML = isDark ? '&#9790;' : '&#9728;';
  buildRing(); // rebuild labels with correct font
}

// ===== STYLE TOGGLE =====
$$('#style-group .pill-btn').forEach(btn => {
  btn.addEventListener('click', () => {
    $$('#style-group .pill-btn').forEach(b => b.classList.remove('active'));
    btn.classList.add('active');
    currentStyle = btn.dataset.style;
    applyTheme();
  });
});

$('#mode-toggle').addEventListener('click', () => {
  isDark = !isDark;
  applyTheme();
});

// ===== YEAR CALCULATIONS =====
const monthNamesShort = ['Jan','Feb','Mar','Apr','May','Jun','Jul','Aug','Sep','Oct','Nov','Dec'];
const monthNamesFull = ['January','February','March','April','May','June','July','August','September','October','November','December'];
const dayNames = ['Sunday','Monday','Tuesday','Wednesday','Thursday','Friday','Saturday'];

function isLeapYear(y) { return (y % 4 === 0 && y % 100 !== 0) || y % 400 === 0; }
function daysInYear(y) { return isLeapYear(y) ? 366 : 365; }

function dayOfYear(d) {
  const start = new Date(d.getFullYear(), 0, 0);
  const diff = d - start;
  return Math.floor(diff / 86400000);
}

function yearProgress(d) {
  const doy = dayOfYear(d);
  const total = daysInYear(d.getFullYear());
  const h = d.getHours(), m = d.getMinutes(), s = d.getSeconds();
  return (doy - 1 + (h * 3600 + m * 60 + s) / 86400) / total;
}

// Month start angles (proportional to actual days)
function getMonthAngles(year) {
  const total = daysInYear(year);
  const daysInMonth = [31, isLeapYear(year) ? 29 : 28, 31, 30, 31, 30, 31, 31, 30, 31, 30, 31];
  const angles = [];
  let cumDays = 0;
  for (let i = 0; i < 12; i++) {
    angles.push((cumDays / total) * 360 - 90); // -90 so Jan starts at top
    cumDays += daysInMonth[i];
  }
  return { angles, daysInMonth, total };
}

// Approximate solstice/equinox day-of-year positions (Northern Hemisphere)
function getSeasonMarkers(year) {
  // Approximate dates — good enough for display
  return [
    { name: 'V.EQ', label: 'Vernal Equinox', doy: 80, season: 'spring' },   // ~Mar 20
    { name: 'S.SOL', label: 'Summer Solstice', doy: 172, season: 'summer' },  // ~Jun 21
    { name: 'A.EQ', label: 'Autumnal Equinox', doy: 266, season: 'autumn' }, // ~Sep 22
    { name: 'W.SOL', label: 'Winter Solstice', doy: 355, season: 'winter' },  // ~Dec 21
  ];
}

function polarToXY(angle, radius) {
  const rad = angle * Math.PI / 180;
  return { x: CX + radius * Math.cos(rad), y: CY + radius * Math.sin(rad) };
}

function describeArc(cx, cy, r, startAngle, endAngle) {
  const start = polarToXY(startAngle, r);
  const end = polarToXY(endAngle, r);
  const largeArc = (endAngle - startAngle) > 180 ? 1 : 0;
  return `M ${start.x} ${start.y} A ${r} ${r} 0 ${largeArc} 1 ${end.x} ${end.y}`;
}

// ===== DAYLIGHT MODEL =====
// Default latitude ~40°N (NYC / Madrid / Beijing). Updated via geolocation if available.
let userLat = 40;

// Solar declination for a given day-of-year (1-indexed)
function solarDeclination(doy) {
  return 23.45 * Math.sin((2 * Math.PI / 365) * (doy - 81));
}

// Daylight hours for a given day-of-year at a given latitude
function daylightHours(doy, lat) {
  const decl = solarDeclination(doy);
  const latRad = lat * Math.PI / 180;
  const declRad = decl * Math.PI / 180;
  const cosHA = -Math.tan(latRad) * Math.tan(declRad);
  // Clamp for polar extremes
  if (cosHA < -1) return 24; // midnight sun
  if (cosHA > 1) return 0;   // polar night
  return (2 / 15) * (Math.acos(cosHA) * 180 / Math.PI);
}

// Pre-compute daylight hours for all 366 days
function computeDaylightData(year) {
  const total = daysInYear(year);
  const data = [];
  let min = 24, max = 0;
  for (let d = 1; d <= total; d++) {
    const h = daylightHours(d, userLat);
    data.push(h);
    if (h < min) min = h;
    if (h > max) max = h;
  }
  return { data, min, max };
}

// Color interpolation: cool blue → warm amber based on normalized daylight
function daylightColor(normalized, isDarkMode) {
  // Dark mode: deep blue (short) → warm gold (long)
  // Light mode: steel blue (short) → amber (long)
  const r1 = isDarkMode ? 60 : 80,  g1 = isDarkMode ? 100 : 120, b1 = isDarkMode ? 180 : 180;
  const r2 = isDarkMode ? 240 : 200, g2 = isDarkMode ? 180 : 140, b2 = isDarkMode ? 50 : 30;
  const t = normalized;
  const r = Math.round(r1 + (r2 - r1) * t);
  const g = Math.round(g1 + (g2 - g1) * t);
  const b = Math.round(b1 + (b2 - b1) * t);
  return `rgb(${r},${g},${b})`;
}

function buildDaylightBars(year, total) {
  const barG = document.getElementById('daylight-bars');
  barG.innerHTML = '';
  const { data, min, max } = computeDaylightData(year);
  const range = max - min || 1;
  const todayDoy = dayOfYear(new Date());

  // Bar dimensions: extend inward from just inside the inner ring border
  const outerR = R - 12;   // just inside the ring
  const maxBarLen = 38;     // max bar length inward
  const minBarLen = 6;      // min bar length

  for (let d = 0; d < total; d++) {
    const angle = ((d / total) * 360 - 90);
    const norm = (data[d] - min) / range;
    const barLen = minBarLen + (maxBarLen - minBarLen) * norm;

    const p1 = polarToXY(angle, outerR);
    const p2 = polarToXY(angle, outerR - barLen);

    const line = document.createElementNS('http://www.w3.org/2000/svg', 'line');
    line.setAttribute('x1', p1.x);
    line.setAttribute('y1', p1.y);
    line.setAttribute('x2', p2.x);
    line.setAttribute('y2', p2.y);
    line.setAttribute('stroke', daylightColor(norm, isDark));
    line.setAttribute('stroke-width', total <= 365 ? '1.1' : '1');
    line.setAttribute('class', 'daylight-bar' + ((d + 1) < todayDoy ? ' past' : ''));
    barG.appendChild(line);
  }
}

// Try geolocation for accurate latitude
if (navigator.geolocation) {
  navigator.geolocation.getCurrentPosition(
    pos => { userLat = pos.coords.latitude; buildRing(); },
    () => {} // silently use default
  );
}

// ===== BUILD RING =====
function buildRing() {
  const now = new Date();
  const year = now.getFullYear();
  const { angles, daysInMonth, total } = getMonthAngles(year);
  const fontFamily = themes[currentStyle][isDark ? 'dark' : 'light'].font;

  // Season arcs
  const seasonG = document.getElementById('seasons');
  seasonG.innerHTML = '';
  const markers = getSeasonMarkers(year);
  const seasonColors = { spring: '#44cc66', summer: '#ffaa22', autumn: '#dd5533', winter: '#4488dd' };
  const seasonRanges = [
    { season: 'winter', start: 0, end: markers[0].doy },
    { season: 'spring', start: markers[0].doy, end: markers[1].doy },
    { season: 'summer', start: markers[1].doy, end: markers[2].doy },
    { season: 'autumn', start: markers[2].doy, end: markers[3].doy },
    { season: 'winter', start: markers[3].doy, end: total },
  ];
  seasonRanges.forEach(sr => {
    const a1 = (sr.start / total) * 360 - 90;
    const a2 = (sr.end / total) * 360 - 90;
    if (a2 > a1) {
      const path = document.createElementNS('http://www.w3.org/2000/svg', 'path');
      path.setAttribute('d', describeArc(CX, CY, R, a1, a2));
      path.setAttribute('class', 'season-arc');
      path.style.stroke = seasonColors[sr.season];
      seasonG.appendChild(path);
    }
  });

  // Daylight bars
  buildDaylightBars(year, total);

  // Ticks
  const tickG = document.getElementById('ticks');
  tickG.innerHTML = '';

  // Month boundary ticks
  angles.forEach((a, i) => {
    const p1 = polarToXY(a, R + 14);
    const p2 = polarToXY(a, R - 11);
    const l = document.createElementNS('http://www.w3.org/2000/svg', 'line');
    l.setAttribute('x1', p1.x); l.setAttribute('y1', p1.y);
    l.setAttribute('x2', p2.x); l.setAttribute('y2', p2.y);
    l.setAttribute('class', 'month-tick');
    tickG.appendChild(l);
  });

  // Week ticks (every ~7 days)
  for (let d = 7; d < total; d += 7) {
    const a = (d / total) * 360 - 90;
    // Skip if too close to a month boundary
    const closeToMonth = angles.some(ma => Math.abs(a - ma) < 2 || Math.abs(a - ma) > 358);
    if (closeToMonth) continue;
    const p1 = polarToXY(a, R + 6);
    const p2 = polarToXY(a, R - 6);
    const l = document.createElementNS('http://www.w3.org/2000/svg', 'line');
    l.setAttribute('x1', p1.x); l.setAttribute('y1', p1.y);
    l.setAttribute('x2', p2.x); l.setAttribute('y2', p2.y);
    l.setAttribute('class', 'week-tick');
    tickG.appendChild(l);
  }

  // Month labels
  const labelG = document.getElementById('labels');
  labelG.innerHTML = '';
  const currentMonth = now.getMonth();
  angles.forEach((a, i) => {
    const nextA = i < 11 ? angles[i + 1] : (total / total) * 360 - 90 + 270;
    const midA = i < 11 ? (a + angles[i + 1]) / 2 : (a + ((total / total) * 360 - 90 + 270)) / 2;

    // Correct mid-angle for December wrapping
    let midAngle;
    if (i < 11) {
      midAngle = (a + angles[i + 1]) / 2;
    } else {
      // Dec: from angles[11] to (360-90) = 270
      midAngle = (a + 270) / 2;
    }

    const p = polarToXY(midAngle, R + 24);
    const t = document.createElementNS('http://www.w3.org/2000/svg', 'text');
    t.setAttribute('x', p.x);
    t.setAttribute('y', p.y);
    t.setAttribute('class', 'month-label' + (i === currentMonth ? ' current-month' : ''));
    t.style.fontFamily = fontFamily;
    t.textContent = monthNamesShort[i];
    labelG.appendChild(t);
  });

  // Solstice/equinox markers
  const markerG = document.getElementById('markers');
  markerG.innerHTML = '';
  markers.forEach(mk => {
    const a = (mk.doy / total) * 360 - 90;
    const pDot = polarToXY(a, R + 15);
    const pLabel = polarToXY(a, R + 48);

    const dot = document.createElementNS('http://www.w3.org/2000/svg', 'circle');
    dot.setAttribute('cx', pDot.x);
    dot.setAttribute('cy', pDot.y);
    dot.setAttribute('r', 2);
    dot.setAttribute('class', 'marker-dot');
    markerG.appendChild(dot);

    const txt = document.createElementNS('http://www.w3.org/2000/svg', 'text');
    txt.setAttribute('x', pLabel.x);
    txt.setAttribute('y', pLabel.y);
    txt.setAttribute('class', 'marker-label');
    txt.style.fontFamily = fontFamily;
    txt.textContent = mk.name;
    markerG.appendChild(txt);
  });

  // Center year
  document.getElementById('center-year').textContent = year;
  document.getElementById('center-year').style.fontFamily = fontFamily;
}

// ===== ANIMATION TICK =====
const handEl = document.getElementById('year-hand');
const dotHalo = document.getElementById('dot-halo');
const dotMain = document.getElementById('dot-main');
const trailArc = document.getElementById('trail-arc');

function getCurrentSeason(doy) {
  const markers = getSeasonMarkers(new Date().getFullYear());
  if (doy < markers[0].doy) return 'Winter';
  if (doy < markers[1].doy) return 'Spring';
  if (doy < markers[2].doy) return 'Summer';
  if (doy < markers[3].doy) return 'Autumn';
  return 'Winter';
}

let lastUpdateSec = -1;

function tick() {
  const now = new Date();
  const pct = yearProgress(now);
  const angle = pct * 360 - 90;

  // Move hand
  const tip = polarToXY(angle, R);
  const tail = polarToXY(angle, 30); // from center area
  handEl.setAttribute('x1', tail.x);
  handEl.setAttribute('y1', tail.y);
  handEl.setAttribute('x2', tip.x);
  handEl.setAttribute('y2', tip.y);

  // Move dot
  const dp = polarToXY(angle, R);
  dotHalo.setAttribute('cx', dp.x);
  dotHalo.setAttribute('cy', dp.y);
  dotMain.setAttribute('cx', dp.x);
  dotMain.setAttribute('cy', dp.y);

  // Trail arc from Jan 1 to now
  const startAngle = -90;
  const endAngle = angle;
  if (endAngle > startAngle) {
    trailArc.setAttribute('d', describeArc(CX, CY, R, startAngle, endAngle));
  }

  // Pulse the halo
  const pulseScale = 1 + 0.3 * Math.sin(Date.now() / 800);
  dotHalo.setAttribute('r', 10 * pulseScale);
  dotHalo.setAttribute('opacity', 0.15 * (1.1 - 0.3 * Math.sin(Date.now() / 800)));

  // Update stats (once per second)
  const sec = now.getSeconds();
  if (sec !== lastUpdateSec) {
    lastUpdateSec = sec;
    const doy = dayOfYear(now);
    const total = daysInYear(now.getFullYear());
    const remain = total - doy;

    $('#stat-pct').innerHTML = `${(pct * 100).toFixed(1)}<span class="unit">%</span>`;
    $('#stat-day').textContent = doy;
    $('#stat-remain').textContent = remain;

    $('#date-line').textContent = `${dayNames[now.getDay()]}  \u00B7  ${monthNamesFull[now.getMonth()]} ${now.getDate()}, ${now.getFullYear()}`;

    // Daylight stat
    const todayLight = daylightHours(doy, userLat);
    const lightH = Math.floor(todayLight);
    const lightM = Math.round((todayLight - lightH) * 60);
    $('#stat-light').innerHTML = `${lightH}<span class="unit">h</span>${String(lightM).padStart(2,'0')}<span class="unit">m</span>`;

    const season = getCurrentSeason(doy);
    const nextSeason = { Winter: 'Spring', Spring: 'Summer', Summer: 'Autumn', Autumn: 'Winter' }[season];
    const gaining = (doy > 355 || doy < 172); // between winter solstice and summer solstice
    const lightTrend = gaining ? 'gaining light' : 'losing light';
    $('#season-line').textContent = `${season}  \u2014  ${lightTrend}`;
  }

  requestAnimationFrame(tick);
}

// ===== INIT =====
applyTheme();
requestAnimationFrame(tick);
</script>
</body>
</html>
